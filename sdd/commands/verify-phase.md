---
argument-hint: <taskname> <phase番号>
---

# 指定したPhaseの成果物が仕様書通りに完成しているかを検証します

このコマンドは `implement-phase` でPhaseを実装した後、そのPhaseの成果物が正しく完成しているかを包括的に検証します。

【引数】
$ARGUMENTS

## 引数の形式
- `<taskname>` - タスク名（specs/[taskname]/ディレクトリ）
- `<phase番号>` - 検証対象のPhase番号（1, 2, 3...）

例：
- `/sdd:verify-phase user-authentication 1` - user-authenticationのPhase 1を検証
- `/sdd:verify-phase payment-integration 2` - payment-integrationのPhase 2を検証

## 検証手順

### 1. 引数の確認とディレクトリの検証

1. **引数の解析**
   - タスク名とPhase番号が指定されているか確認
   - タスク名のみ指定された場合: AskUserQuestionツールでPhase番号を選択させる
   - 引数が一切指定されていない場合:
     - `specs/`ディレクトリ内のタスクをリスト表示
     - AskUserQuestionツールでタスクとPhase番号を順次選択させる

2. **ディレクトリの存在確認**
   - `specs/[taskname]/` ディレクトリが存在するか確認
   - `specs/[taskname]/tasks/` ディレクトリが存在するか確認
   - 存在しない場合はエラーメッセージを表示

3. **Phase計画書の存在確認**
   - `specs/[taskname]/overview.md` からPhase情報を読み込む
   - 指定されたPhase番号に対応する `phase{N}-*.md` ファイルを探す
   - ファイルが見つからない場合はエラーメッセージを表示

### 2. Phase計画書のタスク完了状況チェック

Phase計画書（`specs/[taskname]/tasks/phase{N}-*.md`）を読み込み、以下を確認：

#### 2-1. タスク目次の確認
- 全タスクの状態が「完了」になっているか確認
- TDDステップ（✅ Red / ✅ Green / ✅ Refactor）がすべて完了しているか確認
- 未完了のタスクがある場合は警告として記録

#### 2-2. タスク詳細セクションの確認
各タスク詳細について以下を確認：
- **状態**: 「完了」になっているか
- **開始日時**: 記録されているか（YYYY-MM-DD HH:MM形式）
- **TDDステップ**: 3つのチェックボックスがすべて完了しているか
  - [ ] Red: テストケース作成
  - [ ] Green: 最小実装
  - [ ] Refactor: リファクタリング
- **依存関係**: 依存するタスクがすべて完了しているか

**チェック結果の記録**:
- ✅ すべてのタスクが完了している
- ⚠️ 一部のタスクが未完了または情報不足
- ❌ 多くのタスクが未完了

### 3. Phase完了条件のチェック

Phase計画書の「Phase完了条件」セクションを確認：

```markdown
## Phase完了条件
- [ ] 全タスク完了
- [ ] 全テスト通過
- [ ] 品質チェックコマンドが成功（lint、type check、buildなど）
- [ ] コードレビュー承認
```

各項目について：
1. **全タスク完了**: ステップ2の結果を使用
2. **全テスト通過**: ユーザーにテストコマンドを確認して実行
3. **品質チェックコマンド成功**: ユーザーに品質チェックコマンドを確認して実行
4. **コードレビュー承認**: 人間の確認が必要なため、ユーザーに確認を促す

**チェック結果の記録**:
- ✅ すべての条件を満たしている
- ⚠️ 一部の条件が未達成
- ❌ 多くの条件が未達成

### 4. 仕様書との整合性チェック

#### 4-1. 機能要件の確認
`specs/[taskname]/specification.md` を読み込み：
- Phase計画書の「実装する機能」リストと照合
- 各機能が specification.md で定義されているか確認
- 機能要件が満たされているかの確認（実装ファイルの存在確認）

#### 4-2. 技術方針の確認
`specs/[taskname]/technical-details.md` を読み込み：
- Phase計画書で言及されている技術スタックとの整合性を確認
- データ設計、API設計との整合性を確認

#### 4-3. コーディング規約の確認
実装ファイルを簡易チェック（Grepツールを使用）：
- **any型の使用**: `any`型が使われていないか確認（禁止事項）
- **interface vs type**: 不必要な `interface` の使用がないか確認
- **barrel import/export**: barrel形式のimport/exportがないか確認（禁止事項）

**チェック結果の記録**:
- ✅ 仕様書と完全に整合している
- ⚠️ 一部の仕様が未実装または確認が必要
- ❌ 重大な不整合がある

### 5. 依存関係の検証

#### 5-1. overview.mdとの整合性
`specs/[taskname]/overview.md` を読み込み：
- Phaseの状態が「完了」または「進行中→完了」に更新されているか確認
- 後続Phaseの依存関係が満たされているか確認

#### 5-2. 次Phaseへの引き継ぎ事項の確認
Phase計画書の「次Phaseへの引き継ぎ事項」セクションを確認：
- 引き継ぎが必要な成果物が揃っているか
- 未解決の課題や技術的負債が明記されているか

**チェック結果の記録**:
- ✅ 依存関係がすべて満たされている
- ⚠️ 一部の依存関係が不明確
- ❌ 重要な依存関係が満たされていない

### 6. 品質チェックコマンドの実行

ユーザーに品質チェックコマンドを確認：
- AskUserQuestionツールを使用して「品質チェックのためのコマンドを教えてください」と質問
- 例: `npm run lint && npm run type-check && npm run build`
- 例: `volta run --node $(cat .node-version) yarn lint && yarn test`

**実行とチェック**:
1. ユーザーが指定したコマンドを実行
2. 実行結果を確認：
   - 終了コード0（成功）: ✅
   - 終了コード非0（失敗）: ❌ エラー内容を記録
3. ログの中にエラーや警告がないか確認

### 7. 検証結果レポートの生成

すべてのチェックが完了したら、以下の形式でレポートを出力：

```markdown
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🔍 Phase {N} 検証レポート
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📍 タスク: specs/{taskname}/
📊 Phase: Phase {N} - {phaseName}
📅 検証日時: {YYYY-MM-DD HH:MM}

## 総合評価
{✅ すべての検証項目をクリア / ⚠️ 一部の項目に問題あり / ❌ 重大な問題あり}

## 検証結果詳細

### 1. タスク完了状況
{✅/⚠️/❌} タスク完了率: {completed}/{total} タスク
{完了タスクのリストと未完了タスクのリスト}

### 2. Phase完了条件
{✅/⚠️/❌} 完了条件達成率: {completed}/{total} 項目
- {✅/❌} 全タスク完了
- {✅/❌} 全テスト通過
- {✅/❌} 品質チェックコマンド成功
- {⚠️} コードレビュー承認（要人間確認）

### 3. 仕様書との整合性
{✅/⚠️/❌} 整合性チェック結果
- 機能要件: {✅/⚠️/❌}
- 技術方針: {✅/⚠️/❌}
- コーディング規約: {✅/⚠️/❌}
{問題がある場合は詳細を記載}

### 4. 依存関係
{✅/⚠️/❌} 依存関係チェック結果
- overview.md状態更新: {✅/⚠️/❌}
- 次Phaseへの引き継ぎ: {✅/⚠️/❌}
{問題がある場合は詳細を記載}

### 5. 品質チェック
{✅/❌} 品質チェックコマンド: {コマンド}
{エラーがある場合は詳細を記載}

## 🚨 要対応項目
{未完了タスク、エラー、警告など、対応が必要な項目のリスト}

## 💡 次のアクション
{✅ の場合}
- overview.mdのPhase状態を「完了」に更新することを推奨
- 次のPhase（Phase {N+1}）に進むことができます
- 次のコマンド: `/sdd:implement-phase {taskname} {N+1}.1`

{⚠️ の場合}
- 未完了タスクや問題を解決してください
- 解決後、再度このコマンドで検証してください
- 再検証コマンド: `/sdd:verify-phase {taskname} {N}`

{❌ の場合}
- 重大な問題があります。まず以下を解決してください:
  {問題リスト}
- 解決後、再度このコマンドで検証してください

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

### 8. 各問題について個別に対応方針を確認

総合評価が ⚠️ または ❌ の場合、見つかった問題について**各問題ごとに個別のAskUserQuestion**を用意し、**1つのメッセージでまとめて質問**してください。

**AskUserQuestionツールの制約**: 1回のツール呼び出しで最大4問まで

**手順**:
1. 見つかった全問題を優先度順にリストアップ
2. 各問題について、具体的な修正方法の対応方針案を考える
3. 問題を最大4問ずつのグループに分割
4. 各グループについて、1つのメッセージでAskUserQuestionツールを実行

**各質問の形式**:
- question: 「{問題の説明}（場所: {パス}:{行}）この問題にどう対応しますか？」
- header: 「{問題カテゴリ}」（例: "タスク未完了", "品質チェック失敗"）
- multiSelect: false

**選択肢の作り方**:
各選択肢の`label`に具体的な対応方針案を書く。必ず「対応しない」選択肢も含める。

例（タスク未完了の問題の場合）:
- label: "不足しているタスクを実装する"
  description: "未完了のタスクを順次実装する"
- label: "タスクをスキップしてPhaseを完了扱いにする"
  description: "このタスクは必須でないと判断し、Phase完了とする"
- label: "対応しない"
  description: "この問題は後で対応する"

例（品質チェック失敗の問題の場合）:
- label: "エラーを修正する"
  description: "品質チェックで検出されたエラーを修正する"
- label: "品質チェックの設定を見直す"
  description: "誤検出の可能性があるため、設定を確認して調整する"
- label: "対応しない"
  description: "この問題は許容範囲として対応しない"

**Todoタスクの作成**:
ユーザーが対応方針を選択したら、**TodoWriteツール**で修正タスクを作成：
- content: 「{選択された対応方針}」
- activeForm: 「{選択された対応方針}中」
- status: "pending"
- 優先度順に並べる

### 9. overview.mdの更新提案（オプション）

総合評価が ✅ の場合のみ、ユーザーに確認：
- AskUserQuestionツールを使用して「overview.mdのPhase状態を『完了』に更新しますか？」と質問
- 承認された場合、overview.mdの該当Phaseの状態を「完了」に更新

## 重要な注意事項

- **自動判定の限界**: このコマンドは機械的にチェック可能な項目を検証しますが、最終的な品質判断は人間が行う必要があります
- **品質チェックコマンド**: プロジェクトごとに異なるため、必ずユーザーに確認してから実行すること
- **テストコマンド**: テストの実行方法もプロジェクトごとに異なるため、ユーザーに確認すること
- **コーディング規約**: 簡易的なチェックのため、詳細なレビューは別途必要
- **仕様の解釈**: 仕様書と実装の整合性は、ファイルの存在確認や簡易的なパターンマッチングで判断するため、詳細な機能チェックは人間が行う必要があります

## 使用例

### 例1: Phase 1の検証
```
/sdd:verify-phase user-authentication 1
```

### 例2: Phase 2の検証
```
/sdd:verify-phase payment-integration 2
```

### 例3: 検証→修正→再検証のサイクル
```
# 1. 検証
/sdd:verify-phase user-authentication 1

# 2. 未完了タスクを確認し、implement-phaseで続きを実装
/sdd:implement-phase user-authentication 1.3

# 3. 再検証
/sdd:verify-phase user-authentication 1
```
