---
argument-hint: <タスク名>
allowed-tools: ["Read", "Edit", "Task", "AskUserQuestion"]
---

# specs内の不明箇所をユーザーに質問して明確化します

このコマンドは `specs/[taskname]/` ディレクトリ内の全ドキュメントから「**不明**」と記載された箇所を抽出し、ユーザーに質問して明確化します。

## コマンドの役割

**`/sdd:clarify-spec`（このコマンド）の役割**:
- **ビジネス要件やユーザーの意思決定**が必要な不明箇所をユーザーに質問
- AIだけでは判断できず、ユーザー（プロダクトオーナー、ステークホルダー）の意思決定が必要な項目
- 例：
  - 機能の優先順位や範囲
  - UIの具体的な仕様（表示項目、レイアウトなど）
  - ビジネスルール（承認フロー、権限設定など）
  - ユーザー体験に関する選択（エラー時の挙動など）

**`/sdd:conduct-research` との違い**:
- **clarify-spec**: ビジネス要件やユーザーの意思決定が必要な項目をユーザーに質問
- **conduct-research**: 技術的な調査が必要な項目をAIが調査・検証
- clarify-specは「ユーザーに聞く」、conduct-researchは「AIが調べる」

**使い分けの例**:
- ✅ clarify: 「ログイン時にメールアドレスとユーザー名のどちらを使うか」（ビジネス要件）
- ✅ research: 「JWT vs セッション認証のパフォーマンス比較」（技術的検証）
- ✅ clarify: 「管理者画面の公開範囲（社内のみ or 顧客も使用）」（ビジネス要件）
- ✅ research: 「PostgreSQL vs MySQL のベンチマーク」（技術的検証）

【対象タスク名】
$ARGUMENTS

## 実行手順

### 1. タスクディレクトリの確認

タスク名が指定されている場合:
- `specs/[taskname]/` ディレクトリの存在を確認
- ディレクトリ内の全マークダウンファイルを取得

タスク名が指定されていない場合:
- `specs/` ディレクトリ内の利用可能なタスクをリスト表示
- ユーザーに選択を求める

### 2. ステアリングドキュメントの読み込み

プロジェクト全体のコンテキストを把握するため、以下のステアリングドキュメントを読み込みます：

**`specs/_steering/product.md`**:
- プロダクトの目的とビジョン
- ターゲットユーザー
- 主要機能とビジネス目標

**`specs/_steering/tech.md`**:
- 技術スタックとアーキテクチャ
- 開発標準（型安全性、コード品質、テスト戦略）
- 重要な技術的決定事項

**`specs/_steering/structure.md`**:
- プロジェクト構造と命名規則
- コード組織原則
- モジュール境界

**ステアリングドキュメントが存在しない場合**:
- 警告メッセージを表示: 「⚠️ ステアリングドキュメントが見つかりません。プロジェクト固有のコンテキストなしで進めます。」
- `/sdd:steering` コマンドでステアリングドキュメントを作成することを推奨
- 処理は続行（ステアリングドキュメントは必須ではない）

### 3. 不明箇所の抽出

`specs/[taskname]/` および `specs/[taskname]/tasks/` 内の全マークダウンファイルを検索し、以下のパターンを抽出:

- 「**不明**」または「不明」と記載された箇所
- その周辺のコンテキスト（前後数行）
- 記載されている複数の案（案A、案B、案Cなど）

各不明箇所について以下の情報を収集:
- **ファイル名**: どのファイルに記載されているか
- **セクション名**: どのセクションの内容か
- **不明な内容**: 何が不明なのか
- **提示されている案**: 案A、案B、案Cなど

### 4. 不明箇所の整理とグループ化

抽出した不明箇所を以下のように整理:

```markdown
## 不明箇所の一覧

### 不明箇所 1: [不明な内容の要約]
- **ファイル**: overview.md
- **セクション**: Phase 1の目標
- **不明な内容**: 認証方式の選択
- **提示されている案**:
  - 案A: JWT認証
  - 案B: セッションベース認証
  - 案C: OAuth2.0

### 不明箇所 2: [不明な内容の要約]
...
```

### 5. ユーザーへの質問

各不明箇所について、AskUserQuestionツールを使用してユーザーに質問:

- 質問は明確で具体的にすること
- 提示されている案をそのまま選択肢として提示
- 1つずつ順番に質問するのではなく、可能な限り複数の質問をまとめて提示
- ユーザーが「その他」を選択した場合は自由記述で詳細を取得

例:
```
質問: Phase 1で使用する認証方式を選択してください
選択肢:
- 案A: JWT認証
- 案B: セッションベース認証
- 案C: OAuth2.0
```

### 6. 回答の反映

ユーザーの回答を元に、該当ファイルの「**不明**」箇所を更新:

**更新前**:
```markdown
## 認証方式
**不明**: 以下の案から選択
- 案A: JWT認証
- 案B: セッションベース認証
- 案C: OAuth2.0
```

**更新後**:
```markdown
## 認証方式
JWT認証を使用する
```

### 7. 完了報告

全ての不明箇所を更新後、以下を報告:

```
✅ 不明箇所を明確化しました
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📍 対象ディレクトリ: specs/[taskname]/
📝 更新されたファイル:
   - overview.md (2箇所更新)
   - specification.md (1箇所更新)
   - tasks/phase1-foundation.md (3箇所更新)
   ...

✨ 明確化された項目:
   1. Phase 1の認証方式: JWT認証
   2. データベース: PostgreSQL
   3. デプロイ環境: AWS
   ...

💡 次のアクション:
   - 仕様書の内容を確認してください
   - 必要に応じて `/sdd:break-down-phase [taskname]` でPhase別計画書を更新
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

## 注意事項

- 不明箇所が見つからない場合は、その旨を報告してコマンドを終了
- ユーザーが「その他」を選択した場合は、その内容をそのまま反映
- 更新時は「**不明**」の記述と案のリストを全て削除し、選択された内容のみを記載
- 複数ファイルにまたがる不明箇所も漏れなく更新すること
- 更新前に必ずファイルの内容を読み込み、正確な位置を特定すること

## ステアリングドキュメントレビュー（必須）

明確化後のドキュメントがステアリングドキュメントに準拠しているか必ず steering-reviewer SubAgent を使用して確認してください：

```bash
# steering-reviewer SubAgentを使用（指摘のみ、修正は行わない）
Task(steering-reviewer): specs/[taskname]/ 配下の全ドキュメントをレビューしてください。product.mdのビジネス目標との整合性、tech.mdの技術方針との整合性を確認してください。
```

## 矛盾チェック（必須）

明確化後、仕様書間の矛盾がないか必ず contradiction-checker SubAgent を使用して確認してください：

```bash
# contradiction-checker SubAgentを使用（指摘のみ、修正は行わない）
Task(contradiction-checker): specs/[taskname]/ の全ドキュメント間の矛盾をチェックしてください。明確化による変更が他のドキュメントと整合しているか確認してください。
```
