---
argument-hint: <タスク名>
---

# 既存specsプロジェクトのPhase別計画書を生成・管理します

このコマンドは既存の `specs/[taskname]/` ディレクトリに対して、**TDD（Test-Driven Development）とSOLID原則**に基づいたPhase別の詳細計画書を `specs/[taskname]/tasks/` ディレクトリ内に生成・更新します。

【対象タスク名】
$ARGUMENTS

## Phase分けの基本方針

Phase分けは以下の原則に基づいて行います：

### タスク分解の方針

#### Phase分けの基準
Phaseは以下の基準で分割してください：

1. **独立してデプロイ・リリース可能な単位**
   - 各Phaseは独立して動作確認とリリースができる状態になるように分割
   - Phase完了時点で品質チェックに成功する状態であること（必須）

2. **機能の依存関係による分割**
   - 後続Phaseが前Phaseの成果物に依存する構造
   - 並行開発可能なPhaseは別々に分ける

3. **リスクとビジネス価値による優先順位付け**
   - 高リスク・高価値の機能は早期のPhaseで実装
   - 基盤機能 → コア機能 → 拡張機能の順に配置

#### Phase内のタスク分けの基準
各Phase内でさらに小さいタスクに分ける場合、以下の基準を適用してください：

1. **適切な粒度の単位**
   - 大きすぎる場合はさらに分割を検討
   - 小さすぎる場合は統合を検討

2. **TDDサイクルが完結する単位**
   - Red → Green → Refactor のサイクルが1回以上完結すること
   - テストと実装がセットで完了すること

3. **単一の機能または責任を持つ単位**
   - 単一責任の原則に従う
   - タスク名が「〇〇と△△」のように複数の責任を示す場合は分割

4. **他のタスクとの依存関係が明確**
   - タスクAが完了しないとタスクBに着手できない場合は依存関係を明記
   - 並行作業可能なタスクは独立させる

#### 具体例：空のWebアプリにログイン機能を実装する場合

**Phase 1: ユーザーテーブルとモデル**
- タスク1: ユーザーテーブルのマイグレーションファイル作成
- タスク2: マイグレーション実行とテスト
- タスク3: ユーザーモデルの基本構造作成（ID、メール、パスワードハッシュフィールド）

**Phase 2: ログインAPI**
- タスク1: ログインエンドポイントの骨組み作成（POST /api/auth/login、リクエスト受付のみ）
- タスク2: パスワード検証ロジックの実装
- タスク3: JWTトークン生成機能の実装

**Phase 3: ログインUI**
- タスク1: ログインフォームコンポーネントの骨組み作成（メール・パスワード入力欄のみ）
- タスク2: フォーム送信処理とAPIとの連携
- タスク3: エラー表示UI（バリデーションエラー、認証エラー）

各タスクはTDDサイクル（Red→Green→Refactor）が1回完結する粒度です。

### TDD（Test-Driven Development）原則
- **Red**: テストを先に書く（失敗するテストの作成）
- **Green**: テストを通すための最小限の実装
- **Refactor**: コードのリファクタリング

各Phaseでテストファーストのアプローチを採用し、テストが開発を駆動する形で進めます。

### 設計原則
- **単一責任の原則 (SRP)**: 各Phase/タスク/関数は単一の責任を持つ
- **開放/閉鎖の原則 (OCP)**: 拡張に対して開いており、修正に対して閉じている設計
- **リスコフの置換原則 (LSP)**: 型の一貫性と期待される振る舞いを保つ
- **最小限の公開**: 必要な機能のみを公開し、内部実装の詳細は隠蔽する。小さく焦点を絞った関数設計を心がける
- **依存性逆転の原則 (DIP)**: 具体的な実装ではなく、契約（関数シグネチャ）に依存する

### ⚠️ 重要な制約事項
**インターフェースや抽象クラスの使用は、それを使用しなければ実現できない時以外は禁止です。**
- コンポジションと依存性注入（関数やオブジェクトを引数として渡す）で解決できる場合は、必ずそちらを選択すること
- 過度な抽象化を避け、具体的で実用的な実装を優先すること

**型定義だけを先に作ることは絶対に行わないこと**
- タスク単位で型定義だけを作ることは禁止
- 実装を作った後、他でもその型を使用する場合に分離する
- 型定義と実装は常にセットで進める。型だけ先行すると実態と乖離する

## 実行手順

### 1. タスクディレクトリの確認

タスク名が指定されている場合:
- `specs/[taskname]/` ディレクトリの存在を確認
- `specs/[taskname]/overview.md`、`specification.md`、`technical-details.md` が存在するか確認
- `specs/[taskname]/tasks/` ディレクトリが存在しない場合は作成

タスク名が指定されていない場合:
- `specs/` ディレクトリ内の利用可能なタスクをリスト表示
- **AskUserQuestionツールを使用**してどのタスクについて作業するかユーザーに選択を求める

### 2. 既存ドキュメントの分析

以下のドキュメントから情報を抽出:

**`overview.md`**:
- 既存のPhase概要と依存関係セクション
- Phaseの数と各Phaseの名前
- 各Phaseの状態、目標、依存関係

**`specification.md`**:
- 機能要件の詳細
- 各機能の実装Phase
- 非機能要件

**`technical-details.md`**:
- 技術スタックと技術選定
- データ設計とAPI設計
- セキュリティ要件

### 3. Phase分けの確認

Phase別計画書の生成を開始する前に、ユーザーにPhase分けの妥当性を確認:

1. **Phase情報の整理と表示**
   - overview.mdから抽出したPhase情報を整理
   - 各Phaseの名前、目標、依存関係を分かりやすく表示
   - Phase数と全体の構成を提示

2. **ユーザーへの確認**
   - **AskUserQuestionツールを使用**してPhase分けが適切か確認
   - 質問内容: 「このPhase分けで詳細な計画書を作成してよろしいですか？」
   - 選択肢:
     - 「承認（このまま進める）」
     - 「修正が必要（overview.mdを先に修正したい）」

3. **承認された場合のみ次ステップへ進む**
   - ユーザーが承認した場合: ステップ4「Phase別計画書の生成/更新」へ進む
   - 修正が必要な場合: 処理を中断し、overview.mdの修正を促すメッセージを表示

### 4. Phase別計画書の生成/更新

`specs/[taskname]/tasks/` ディレクトリ内に各Phaseに対して `phase{N}-{phaseName}.md` ファイルを生成または更新:

```markdown
# Phase {N}: {phaseName} 計画書

## Phase概要
- **Phase名**: {phaseName}
- **状態**: 未着手/進行中/完了/保留
- **目標**:

## TDD & 設計原則の適用

### TDDアプローチ
このPhaseでは以下のTDDサイクルを適用します：

1. **Red（テスト作成）**: 実装前にテストケースを作成し、期待される振る舞いを明確に定義
2. **Green（最小実装）**: テストを通すための最小限の実装、過剰な設計を避ける
3. **Refactor（リファクタリング）**: コードの品質向上とパフォーマンス最適化

### 設計原則の適用方針

- **単一責任の原則 (SRP)**: 各関数/モジュールが持つべき単一の責任を明確にする
- **開放/閉鎖の原則 (OCP)**: コンポジションと設定により現在必要な拡張ポイントを設計する
- **リスコフの置換原則 (LSP)**: 型の一貫性と期待される振る舞いを保つ
- **最小限の公開**: 必要な機能のみを公開し、小さく焦点を絞った関数設計
- **依存性逆転の原則 (DIP)**: 依存性注入（関数やオブジェクトを引数として渡す）により疎結合な設計

⚠️ **インターフェースや抽象クラスは、それを使用しなければ実現できない時以外は使用禁止**
⚠️ **型定義だけを先に作ることは絶対に行わないこと**: タスク単位で型定義だけを作ることは禁止。実装を作った後、他でもその型を使用する場合に分離する

## 依存関係
- **前提条件**: [Phase N-1の完了、必要なライブラリの選定など]
- **ブロッカー**: [なし、または現在のブロッカー]
- **後続Phaseへの影響**: [Phase N+1が依存する機能]

## 実装する機能
- 機能1
- 機能2
- 機能3

## タスク詳細

### タスク1: [タスク名]
- **説明**:
- **開始日時**: YYYY-MM-DD HH:MM（未着手の場合は空欄）
- **TDDステップ**:
  - [ ] Red: テストケース作成
  - [ ] Green: 最小実装
  - [ ] Refactor: リファクタリング
- **依存関係**: [タスク〇〇の完了後に着手可能]
- **状態**: 未着手/進行中/完了/保留

### タスク2: [タスク名]
- **説明**:
- **開始日時**: YYYY-MM-DD HH:MM（未着手の場合は空欄）
- **TDDステップ**:
  - [ ] Red: テストケース作成
  - [ ] Green: 最小実装
  - [ ] Refactor: リファクタリング
- **依存関係**:
- **状態**: 未着手/進行中/完了/保留

## テスト戦略

- **単体テスト**: 各関数/メソッドの振る舞いを検証
- **統合テスト**: モジュール間の連携を検証
- **E2Eテスト**: エンドユーザーの視点からの動作を検証

## Phase完了条件
- [ ] 全タスク完了
- [ ] 全テスト通過
- [ ] 品質チェックコマンドが成功（lint、type check、buildなど）
- [ ] コードレビュー承認

## 技術的課題と解決方針
[想定される課題と解決方針を記述]

## リスク管理
[Phase固有のリスクと対策を記述]

## 次Phaseへの引き継ぎ事項
[Phase N+1で利用可能になる機能、未解決の課題、技術的負債]
```

### 5. 生成・更新モードの判定

各 `specs/[taskname]/tasks/phase{N}-{phaseName}.md` について:
- **ファイルが存在しない場合**: 新規作成
- **ファイルが存在する場合**:
  - 既存内容を確認
  - ユーザーに「上書き/スキップ/マージ」を確認
  - マージの場合は既存の進捗情報（チェックボックスの状態、開始日時、完了済みタスク）を保持しながら更新

### 6. Phase依存関係の整合性チェック

- 各Phaseの依存関係が論理的に正しいか検証
- 循環依存がないか確認
- 依存関係の不整合があれば警告を表示

### 7. 完了報告

```
✅ Phase別計画書を生成/更新しました
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📍 対象ディレクトリ: specs/[taskname]/tasks/
📝 生成/更新されたファイル:
   - tasks/phase1-{name}.md (新規作成)
   - tasks/phase2-{name}.md (新規作成)
   - tasks/phase3-{name}.md (更新)
   ...

📊 Phase概要:
   Phase 1: {name} - 状態: {status}
   Phase 2: {name} - 状態: {status}
   Phase 3: {name} - 状態: {status}
   ...

💡 次のアクション:
   - 各Phaseのタスク詳細を確認・編集してください
   - TDDサイクル（Red→Green→Refactor）を意識して進めてください
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

## 注意事項

- **⚠️ 重要**: 詳細であれば詳細であるほど良いわけではない。必要な部分だけを必要なだけ書くこと
- **⚠️ 重要**: インターフェースや抽象クラスは、それを使用しなければ実現できない時以外は使用禁止
- **⚠️ 重要**: 型定義だけを先に作ることは絶対に行わないこと。タスク単位で型定義だけを作ることは禁止。実装を作った後、他でもその型を使用する場合に分離する
- **⚠️ 重要**: 推測される開発期間、工数、見積もり時間などは一切記載しないこと（タスクの開始日時は記録する）
- **⚠️ 重要**: 「将来的に必要になる」「今後〜が必要」といった適当な推測に基づいた記述は禁止。現時点で明確に必要なことのみを記載すること
- **⚠️ 重要**: 不明なところは勝手に決めずに「**不明**」と明記し、複数の案（案A、案B、案Cなど）を記述すること。ユーザーは `/sdd:clarify-spec [taskname]` コマンドで不明箇所を明確化できる
- **配置先**: `specs/[taskname]/tasks/` ディレクトリ内にPhase別ファイルを作成
- 既存のPhase計画書がある場合、進捗情報（状態、タスクの開始日時、チェックボックス、完了済みタスク）は保持する
- **TDD原則**: 各タスクでRed→Green→Refactorサイクルを明記
- **設計原則**: 各Phase/タスクでどの設計原則を適用するか明確に記述
- 依存関係は具体的かつ明確に記述し、依存性注入（関数やオブジェクトを引数として渡す）を活用
- overview.mdの「Phase概要と依存関係」セクションと整合性を保つ
- Phase名は overview.md から自動抽出するが、不明な場合はユーザーに確認する
- 各Phaseのファイル名は `phase1-foundation.md`, `phase2-core-features.md` のような形式を推奨
